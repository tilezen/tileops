version: 0.2

env:
  variables:
    # WARNING! you _must_ set this in the codebuild GUI.
    BUCKET_PREFIX: ""
    # this is set to the latest available planet if you don't override it in the GUI!
    PLANET_DATE: ""
    # versions (git hashes, branches or tags) of software to install on the TPS instance. note that the version of cron.py that's run is determined by the uploaded version of the codebuild package, not this environment variable!
    RAW_TILES_VERSION: master
    TILEQUEUE_VERSION: master
    VECTOR_DATASOURCE_VERSION: master
    TILEOPS_VERSION: master

phases:
  install:
    commands:
      - pip install pipenv
      - pipenv sync
  build:
    commands:
      # set planet date to latest planet, if it wasn't already set by the environment.
      - >
          if [ -z "$PLANET_DATE" ]; then
            PLANET_DATE=`curl -Is https://planet.openstreetmap.org/planet/planet-latest.osm.bz2 |
                         grep "Location: " |
                         sed 's,.*/planet-\([0-9]\{6\}\).osm.bz2\r$,\1,;t ok;q 1;:ok'`;
          fi
      - pipenv run python batch-setup/cron.py --bucket-prefix $BUCKET_PREFIX --raw-tiles-version $RAW_TILES_VERSION --tilequeue-version $TILEQUEUE_VERSION --vector-datasource-version $VECTOR_DATASOURCE_VERSION --tileops-version $TILEOPS_VERSION $PLANET_DATE
